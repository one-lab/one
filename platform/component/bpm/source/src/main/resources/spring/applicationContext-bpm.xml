<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:drools="http://drools.org/schema/drools-spring"
	xmlns:aop="http://www.springframework.org/schema/aop" xmlns:context="http://www.springframework.org/schema/context"
	xmlns:tx="http://www.springframework.org/schema/tx"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
	http://www.springframework.org/schema/beans/spring-beans-3.0.xsd 
	http://drools.org/schema/drools-spring http://drools.org/schema/drools-spring/org/drools/container/spring/drools-spring-1.3.0.xsd 
	http://www.springframework.org/schema/aop 
	http://www.springframework.org/schema/aop/spring-aop-3.0.xsd 
	http://www.springframework.org/schema/context 
	http://www.springframework.org/schema/context/spring-context.xsd
	http://www.springframework.org/schema/tx
	http://www.springframework.org/schema/tx/spring-tx.xsd"
	default-autowire="byName" default-lazy-init="false">

	<bean id="ds" class="org.apache.commons.dbcp.BasicDataSource">
		<property name="driverClassName" value="${jdbc.driverClassName}" />
		<property name="url" value="${jdbc.url}" />
		<property name="username" value="${jdbc.username}" />
		<property name="password" value="${jdbc.password}" />
		<property name="initialSize" value="1" />
		<property name="maxActive" value="${jdbc.maxActive}" />
	</bean>

	<bean id="bpmEmf"
		class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
		<property name="dataSource" ref="ds" />
		<property name="persistenceUnitName" value="org.drools.persistence.jpa.local" />
		<property name="persistenceXmlLocation" value="classpath:config/META-INF/persistence.xml" />
		<property name="jpaVendorAdapter">
			<bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter">
				<property name="databasePlatform" value="${hibernate.dialect}" />
			</bean>
		</property>
		<property name="jpaProperties">
			<props>
				<prop key="hibernate.hbm2ddl.auto">${hibernate.hbm2ddl.auto}</prop>
				<prop key="hibernate.max_fetch_depth">${hibernate.max_fetch_depth}</prop>
				<prop key="hibernate.show_sql">${hibernate.show_sql}</prop>
			</props>
		</property>
	</bean>
	<bean id="bpmTxManager" class="org.springframework.orm.jpa.JpaTransactionManager">
		<property name="entityManagerFactory" ref="bpmEmf" />
	</bean>

	<tx:advice id="txAdvice" transaction-manager="bpmTxManager">
		<!-- the transactional semantics... -->
		<tx:attributes>
			<!-- all methods starting with 'get' are read-only -->
			<tx:method name="get*" read-only="true" />
			<!-- other methods use the default transaction settings (see below) -->
			<tx:method name="*" />
		</tx:attributes>
	</tx:advice>
	<!-- ensure that the above transactional advice runs for any execution of 
		an operation defined by the FooService interface -->
	<aop:config>
		<aop:pointcut id="processInstanceBOServiceOperation"
			expression="execution(* com.sinosoft.one.bpm.service.spring.ProcessInstanceBOServiceSpringImpl.*(..))" />
		<aop:advisor advice-ref="txAdvice" pointcut-ref="processInstanceBOServiceOperation" />
	</aop:config>
	<aop:config>
		<aop:aspect ref="bpmTraceAspect">
			<aop:around method="getTask"
				pointcut="execution(${bpm.aspect.expression}) and @annotation(com.sinosoft.one.bpm.aspect.GetTask)" />
			<aop:around method="processTask"
				pointcut="execution(${bpm.aspect.expression}) and @annotation(com.sinosoft.one.bpm.aspect.ProcessTask)" />
			<aop:around method="startProcess"
				pointcut="execution(${bpm.aspect.expression}) and @annotation(com.sinosoft.one.bpm.aspect.StartProcess )" />
		</aop:aspect>
	</aop:config>

	<bean id="processInstanceBOService"
		class="com.sinosoft.one.bpm.service.spring.ProcessInstanceBOServiceSpringImpl">
	</bean>

	<bean id="processInstanceBOCache" class="com.sinosoft.one.bpm.util.ProcessInstanceBOCache">
		<property name="processInstanceBOService" ref="processInstanceBOService" />
	</bean>

	<bean id="bpmServiceSupport" scope="singleton"
		class="com.sinosoft.one.bpm.util.BpmServiceSupport" init-method="init"
		destroy-method="destory">
		<property name="bpmEmf" ref="bpmEmf" />
		<property name="bpmTxManager" ref="bpmTxManager" />
		<property name="cache" ref="processInstanceBOCache" />
	</bean>

	<bean id="bpmService"
		class="com.sinosoft.one.bpm.service.spring.BpmServiceSpringImpl">
		<property name="cache" ref="processInstanceBOCache" />
		<property name="bpmServiceSupport" ref="bpmServiceSupport" />
	</bean>

	<bean id="jpbmAPIUtil" class="com.sinosoft.one.bpm.util.JbpmAPIUtil">
		<property name="bpmServiceSupport" ref="bpmServiceSupport" />
	</bean>

	<bean id="bpmTraceAspect" class="com.sinosoft.one.bpm.aspect.TaskAspect" />
</beans>